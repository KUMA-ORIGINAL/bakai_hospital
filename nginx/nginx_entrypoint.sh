#!/bin/sh

set -e  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

# –ü—Ä–∏–≤–æ–¥–∏–º GET_CERTS –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
get_certs_lower=$(echo "$GET_CERTS" | tr '[:upper:]' '[:lower:]')

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
if [ -z "$DOMAIN" ] || [ -z "$CORE_DOMAIN" ] || [ -z "$CERTBOT_EMAIL" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ –∑–∞–¥–∞–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ DOMAIN, CORE_DOMAIN –∏–ª–∏ CERTBOT_EMAIL"
    exit 1
fi

if [ "$get_certs_lower" = "true" ]; then
    echo "üîß –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ nginx –∑–∞–ø—É—â–µ–Ω
    if ! nginx -t > /dev/null 2>&1; then
        echo "‚ùå –û—à–∏–±–∫–∞: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
        exit 1
    fi

    domains="$DOMAIN $CORE_DOMAIN"
    cert_obtained=false

    for domain in $domains; do
        echo "üÜï –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è $domain..."

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–æ–º–µ–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        if ! nslookup "$domain" > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –î–æ–º–µ–Ω $domain –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        fi

        # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        if certbot certonly \
            --nginx \
            --email "$CERTBOT_EMAIL" \
            --agree-tos \
            --no-eff-email \
            --non-interactive \
            --expand \
            --keep-until-expiring \
            -d "$domain" -d "www.$domain"; then

            echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è $domain —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω"
            cert_obtained=true
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è $domain"
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö –¥–æ–º–µ–Ω–æ–≤
        fi
    done

    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –±—ã–ª –ø–æ–ª—É—á–µ–Ω
    if [ "$cert_obtained" = true ]; then
        echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx..."

        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        if nginx -t; then
            # Graceful reload –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            nginx -s reload
            echo "‚úÖ Nginx —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –æ—Ç–º–µ–Ω–µ–Ω"
            exit 1
        fi
    else
        echo "‚ö†Ô∏è  –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –±—ã–ª–∏ –ø–æ–ª—É—á–µ–Ω—ã, nginx –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è"
    fi

    echo "üéâ –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω!"
else
    echo "‚ÑπÔ∏è  GET_CERTS –Ω–µ —Ä–∞–≤–µ–Ω 'true', –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
fi